<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="2"><p><A href=http://www.atmel.com ><img src="atmel.jpg"/ border=0></A></p><br /></td>
    <td colspan="2"> <strong><font face="Helvetica" color="#000000" size="+3">Xmega Application Note</font></strong></td>
    <td colspan="2"><p><A href=http://www.atmel.com/products/AVR><img src="AVR_logo_blue.gif"/ border=0></A></p><br /></td>
  </tr>
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>
</table>
<!-- Generated by Doxygen 1.5.8 -->
<h1>clksys_driver.c</h1><a href="clksys__driver_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00070"></a>00070 <span class="comment">//_____ I N C L U D E S ____________________________________________________</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include "<a class="code" href="clksys__driver_8h.html" title="XMEGA Clock System driver header file.">clksys_driver.h</a>"</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">//_____ M A C R O S ________________________________________________________</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">//_____ D E F I N I T I O N ________________________________________________</span>
<a name="l00076"></a>00076 
<a name="l00085"></a><a class="code" href="clksys__driver_8h.html#ad4e162434c2cc7e0087bbc0ddfe266c">00085</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#ad4e162434c2cc7e0087bbc0ddfe266c" title="CCP write helper function written in assembly.">CCPWrite</a>( <span class="keyword">volatile</span> uint8_t * address, uint8_t value )
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087 <span class="preprocessor">#ifdef __ICCAVR__</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>        <span class="keyword">asm</span>(<span class="stringliteral">"movw r30, r16"</span>);
<a name="l00089"></a>00089 <span class="preprocessor">#ifdef RAMPZ</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>        RAMPZ = 0;
<a name="l00091"></a>00091 <span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>        <span class="keyword">asm</span>(<span class="stringliteral">"ldi  r16,  0xD8 \n"</span>
<a name="l00093"></a>00093             <span class="stringliteral">"out  0x34, r16  \n"</span>
<a name="l00094"></a>00094             <span class="stringliteral">"st     Z,  r18  \n"</span>);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#elif defined __GNUC__</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>        <span class="keyword">volatile</span> uint8_t * tmpAddr = address;
<a name="l00098"></a>00098 <span class="preprocessor">#ifdef RAMPZ</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>        RAMPZ = 0;
<a name="l00100"></a>00100 <span class="preprocessor">#endif</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>        <span class="keyword">asm</span> <span class="keyword">volatile</span>(
<a name="l00102"></a>00102                 <span class="stringliteral">"movw r30,  %0"</span> <span class="stringliteral">"\n\t"</span>
<a name="l00103"></a>00103                 <span class="stringliteral">"ldi  r16,  %2"</span> <span class="stringliteral">"\n\t"</span>
<a name="l00104"></a>00104                 <span class="stringliteral">"out   %3, r16"</span> <span class="stringliteral">"\n\t"</span>
<a name="l00105"></a>00105                 <span class="stringliteral">"st     Z,  %1"</span>
<a name="l00106"></a>00106                 :
<a name="l00107"></a>00107                 : <span class="stringliteral">"r"</span> (tmpAddr), <span class="stringliteral">"r"</span> (value), <span class="stringliteral">"M"</span> (CCP_IOREG_gc), <span class="stringliteral">"m"</span> (CCP)
<a name="l00108"></a>00108                 : <span class="stringliteral">"r16"</span>, <span class="stringliteral">"r30"</span>, <span class="stringliteral">"r31"</span>
<a name="l00109"></a>00109                 );
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="preprocessor">#endif</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>}
<a name="l00113"></a>00113 
<a name="l00128"></a><a class="code" href="clksys__driver_8h.html#ce371b352e90117520436eb125aeeec0">00128</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#ce371b352e90117520436eb125aeeec0" title="This function configures the external oscillator.">CLKSYS_XOSC_Config</a>( OSC_FRQRANGE_t freqRange,
<a name="l00129"></a>00129                          <span class="keywordtype">bool</span> lowPower32kHz,
<a name="l00130"></a>00130                          OSC_XOSCSEL_t xoscModeSelection )
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         OSC.XOSCCTRL = (uint8_t) freqRange |
<a name="l00133"></a>00133                        ( lowPower32kHz ? OSC_X32KLPM_bm : 0 ) |
<a name="l00134"></a>00134                        xoscModeSelection;
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 
<a name="l00154"></a><a class="code" href="clksys__driver_8h.html#cb82744003806825da7fb6a7bb973941">00154</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#cb82744003806825da7fb6a7bb973941" title="This function configures the internal high-frequency PLL.">CLKSYS_PLL_Config</a>( OSC_PLLSRC_t clockSource, uint8_t factor )
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         factor &amp;= OSC_PLLFAC_gm;
<a name="l00157"></a>00157         OSC.PLLCTRL = (uint8_t) clockSource | ( factor );       
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 
<a name="l00174"></a><a class="code" href="clksys__driver_8h.html#31b1ca1994b6a687974a119d1ad8008c">00174</a> uint8_t <a class="code" href="clksys__driver_8c.html#31b1ca1994b6a687974a119d1ad8008c" title="This function disables the selected oscillator.">CLKSYS_Disable</a>( uint8_t oscSel )
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176         OSC.CTRL &amp;= ~oscSel;
<a name="l00177"></a>00177         uint8_t clkEnabled = OSC.CTRL &amp; oscSel;
<a name="l00178"></a>00178         <span class="keywordflow">return</span> clkEnabled;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 
<a name="l00193"></a><a class="code" href="clksys__driver_8h.html#8e350b689dc409a4c9b902a192d1e8a3">00193</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#8e350b689dc409a4c9b902a192d1e8a3" title="This function changes the prescaler configuration.">CLKSYS_Prescalers_Config</a>( CLK_PSADIV_t PSAfactor,
<a name="l00194"></a>00194                                CLK_PSBCDIV_t PSBCfactor )
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         uint8_t PSconfig = (uint8_t) PSAfactor | PSBCfactor;
<a name="l00197"></a>00197         <a class="code" href="clksys__driver_8c.html#ad4e162434c2cc7e0087bbc0ddfe266c" title="CCP write helper function written in assembly.">CCPWrite</a>( &amp;CLK.PSCTRL, PSconfig );
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00212"></a><a class="code" href="clksys__driver_8h.html#1e46c4a8f01a83d4e4747d32d113e7e2">00212</a> uint8_t <a class="code" href="clksys__driver_8c.html#1e46c4a8f01a83d4e4747d32d113e7e2" title="This function selects the main system clock source.">CLKSYS_Main_ClockSource_Select</a>( CLK_SCLKSEL_t clockSource )
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214         uint8_t clkCtrl = ( CLK.CTRL &amp; ~CLK_SCLKSEL_gm ) | clockSource;
<a name="l00215"></a>00215         <a class="code" href="clksys__driver_8c.html#ad4e162434c2cc7e0087bbc0ddfe266c" title="CCP write helper function written in assembly.">CCPWrite</a>( &amp;CLK.CTRL, clkCtrl );
<a name="l00216"></a>00216         clkCtrl = ( CLK.CTRL &amp; clockSource );
<a name="l00217"></a>00217         <span class="keywordflow">return</span> clkCtrl;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 
<a name="l00228"></a><a class="code" href="clksys__driver_8h.html#e622e3056cd713fdca464b9fd6e5a7ab">00228</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#e622e3056cd713fdca464b9fd6e5a7ab" title="This function selects a Real-Time Counter clock source.">CLKSYS_RTC_ClockSource_Enable</a>( CLK_RTCSRC_t clockSource )
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230         CLK.RTCCTRL = ( CLK.RTCCTRL &amp; ~CLK_RTCSRC_gm ) |
<a name="l00231"></a>00231                       clockSource |
<a name="l00232"></a>00232                       CLK_RTCEN_bm;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 
<a name="l00247"></a><a class="code" href="clksys__driver_8h.html#581c15c6c0b2eaa0c81f0b5cafc3b82d">00247</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#581c15c6c0b2eaa0c81f0b5cafc3b82d" title="This function enables automatic calibration of the selected internal oscillator.">CLKSYS_AutoCalibration_Enable</a>( uint8_t clkSource, <span class="keywordtype">bool</span> extReference )
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249         OSC.DFLLCTRL = ( OSC.DFLLCTRL &amp; ~clkSource ) |
<a name="l00250"></a>00250                        ( extReference ? clkSource : 0 );
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (clkSource == OSC_RC2MCREF_bm) {
<a name="l00252"></a>00252                 DFLLRC2M.CTRL |= DFLL_ENABLE_bm;
<a name="l00253"></a>00253         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (clkSource == OSC_RC2MCREF_bm) {
<a name="l00254"></a>00254                 DFLLRC32M.CTRL |= DFLL_ENABLE_bm;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 
<a name="l00267"></a><a class="code" href="clksys__driver_8h.html#bfb0da2d81736412af825d46e7e0cedb">00267</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#bfb0da2d81736412af825d46e7e0cedb" title="This function enables the External Oscillator Failure Detection (XOSCFD) feature...">CLKSYS_XOSC_FailureDetection_Enable</a>( <span class="keywordtype">void</span> )
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269         <a class="code" href="clksys__driver_8c.html#ad4e162434c2cc7e0087bbc0ddfe266c" title="CCP write helper function written in assembly.">CCPWrite</a>( &amp;OSC.XOSCFAIL, ( OSC_XOSCFDIF_bm | OSC_XOSCFDEN_bm ) );
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00279"></a><a class="code" href="clksys__driver_8h.html#6225fea8fc405c6d1dab88d0ad537173">00279</a> <span class="keywordtype">void</span> <a class="code" href="clksys__driver_8c.html#6225fea8fc405c6d1dab88d0ad537173" title="This function lock the entire clock system configuration.">CLKSYS_Configuration_Lock</a>( <span class="keywordtype">void</span> )
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281         <a class="code" href="clksys__driver_8c.html#ad4e162434c2cc7e0087bbc0ddfe266c" title="CCP write helper function written in assembly.">CCPWrite</a>( &amp;CLK.LOCK, CLK_LOCK_bm );
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
</pre></div></div>
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
  <title>@DOC_TITLE@</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>

<table width="100%" height="10%" bgcolor="#FFFFFF">
  <tr>
    <td colspan="6" height="1" background="blue.gif"></td>
  </tr>

  <tr>
    <td colspan="6">
    <address style="align: right;"><small>
Generated on Tue Jan 19 18:41:58 2010 for AVR1320: True 400kHz operation for TWI slave by <a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border=0></a> 1.5.8</small></address>
    </td>
  </tr>

</table>
